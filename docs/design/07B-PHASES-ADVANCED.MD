---
version: "1.0"
last_updated: "2025-11-30"
status: published
tokens: ~1400
---

# Roadmap: Advanced Phases (G-J)

> Advanced feature phases: Event system, memory persistence, DI, and services

---

## Document Series

This document is part of the Implementation Roadmap series:

| Document                       | Content                                |
|--------------------------------|----------------------------------------|
| `07-ROADMAP.MD`                | Overview, status, KPIs, success criteria |
| `07A-PHASES-FOUNDATION.MD`     | Phase 0-F: MVP foundation phases       |
| **07B-PHASES-ADVANCED.MD** (this) | Phase G-J: Advanced feature phases  |

---

## Table of Contents

- [1. Phase G: Event-Driven Plugin Architecture](#1-phase-g-event-driven-plugin-architecture)
- [2. Phase H: Cross-Task Memory Persistence](#2-phase-h-cross-task-memory-persistence)
- [3. Phase I: DI Container](#3-phase-i-di-container)
- [4. Phase J: Configuration & Services](#4-phase-j-configuration--services)

---

## 1. Phase G: Event-Driven Plugin Architecture

**Duration**: Day 9-12 | **Status**: âœ… COMPLETE | **Score**: 99.5/100 ğŸ†

**Goal**: Implement Protocol + EventBus async decoupling for plugin system

| Task | Priority | Status | Deliverable |
|------|----------|--------|-------------|
| Create core/events/ module structure | P0 | âœ… | events/__init__.py, bus.py, events.py, protocols.py |
| Implement Event base class and types | P0 | âœ… | Event, LoadEvent, TimeoutEvent, SearchEvent |
| Implement EventType enum | P0 | âœ… | Standard event types with namespacing |
| Implement Protocol interfaces | P0 | âœ… | LoaderHandler, TimeoutHandler, SearchHandler |
| Implement EventBus with async support | P0 | âœ… | subscribe, publish, wildcard matching |
| Add priority-based subscription ordering | P0 | âœ… | Lower priority = earlier execution |
| Add per-handler timeout protection | P0 | âœ… | Error isolation between handlers |
| Implement PluginAdapter for migration | P1 | âœ… | Backward compatibility with old plugins |
| Add unit tests for EventBus | P0 | âœ… | 39 tests, 89% coverage |

**Directory Structure**:

```
src/sage/core/events/
â”œâ”€â”€ __init__.py          # Exports: EventBus, Event, get_event_bus
â”œâ”€â”€ bus.py               # EventBus implementation
â”œâ”€â”€ events.py            # Event class definitions
â”œâ”€â”€ protocols.py         # Protocol interfaces
â””â”€â”€ adapter.py           # PluginAdapter for migration
```

**Acceptance Criteria**:
- [x] `from sage.core.events import EventBus, Event, get_event_bus` works
- [x] Subscribe/publish pattern with wildcard matching
- [x] Priority-based handler ordering (lower = earlier)
- [x] Per-handler timeout protection with error isolation
- [x] PluginAdapter for legacy plugin compatibility
- [x] 39 event system tests passing

---

## 2. Phase H: Cross-Task Memory Persistence

**Duration**: Day 13-16 | **Status**: âœ… COMPLETE | **Score**: 100/100 ğŸ†

**Goal**: Implement memory persistence, token management, and session continuity

| Task | Priority | Status | Deliverable |
|------|----------|--------|-------------|
| Create core/memory/ module structure | P0 | âœ… | memory/__init__.py, store.py, token_budget.py, session.py |
| Implement MemoryType and MemoryPriority enums | P0 | âœ… | 6 memory types, 6 priority levels |
| Implement MemoryEntry dataclass | P0 | âœ… | Complete entry structure with serialization |
| Implement MemoryStore with file backend | P0 | âœ… | CRUD, query, checkpoint support (78% coverage) |
| Implement TokenWarningLevel enum | P0 | âœ… | 5 warning levels (70%, 80%, 90%, 95%) |
| Implement TokenBudget controller | P0 | âœ… | Real-time tracking, auto-actions (89% coverage) |
| Implement SessionState dataclass | P0 | âœ… | Full session state tracking |
| Implement HandoffPackage with to_prompt() | P0 | âœ… | Cross-task continuation |
| Implement SessionContinuity service | P0 | âœ… | Start, update, checkpoint, handoff (92% coverage) |
| Add unit tests for memory system | P0 | âœ… | 102 tests, 86% average coverage |

**Directory Structure**:

```
src/sage/core/memory/
â”œâ”€â”€ __init__.py          # Exports: MemoryStore, TokenBudget, SessionContinuity
â”œâ”€â”€ store.py             # MemoryStore, MemoryEntry, MemoryType, MemoryPriority
â”œâ”€â”€ token_budget.py      # TokenBudget, TokenWarningLevel, TokenBudgetConfig
â””â”€â”€ session.py           # SessionContinuity, SessionState, HandoffPackage
```

**Storage Location** (platformdirs):

| Platform | Path |
|----------|------|
| Linux | `~/.local/share/sage/memory/` |
| macOS | `~/Library/Application Support/sage/memory/` |
| Windows | `C:\Users\<user>\AppData\Local\sage\memory\` |

**Acceptance Criteria**:
- [x] MemoryStore with file-based persistence
- [x] 6-level memory priority (EPHEMERAL â†’ PERMANENT)
- [x] 5-level token warnings (NORMAL, CAUTION, WARNING, CRITICAL, OVERFLOW)
- [x] Auto-pruning at OVERFLOW level
- [x] Session checkpoint/restore capability
- [x] HandoffPackage with to_prompt() for cross-task continuation
- [x] 102 unit tests with 86% average coverage

---

## 3. Phase I: DI Container

**Duration**: Day 17 | **Status**: âœ… COMPLETE | **Score**: 100/100 ğŸ†

**Goal**: Implement dependency injection container with lifetime management

| Task | Priority | Status | Deliverable |
|------|----------|--------|-------------|
| Create core/di/ module structure | P0 | âœ… | di/__init__.py, container.py |
| Implement lifetime management | P0 | âœ… | Singleton, Transient, Scoped |
| Implement auto-wiring | P0 | âœ… | Type-based dependency resolution |
| Add config/core/di.yaml service registration | P0 | âœ… | Declarative service configuration |
| Add unit tests | P0 | âœ… | 94% test coverage |

**Milestone**: DI container operational with auto-wiring

---

## 4. Phase J: Configuration & Services

**Duration**: Day 18-24 | **Status**: ğŸ”„ IN PROGRESS

**Goal**: Complete configuration system alignment with design document

### Part 1: Configuration Completeness âœ… COMPLETE

| Task | Priority | Status | Deliverable |
|------|----------|--------|-------------|
| Add missing triggers to triggers.yaml | P1 | âœ… | documentation, python triggers |
| Add missing keywords to existing triggers | P1 | âœ… | bug, function, class, method, etc. |
| Add optimization features to features.yaml | P1 | âœ… | client_cache, lazy_expansion, etc. |
| Create src/sage/data/fallback_core.yaml | P1 | âœ… | Fallback content for degradation |
| Create config/services/api.yaml | P1 | âœ… | HTTP API service configuration |
| Create docs/design/09-CONFIGURATION.MD | P1 | âœ… | Configuration design documentation |

### Part 2: DI Services Implementation ğŸ“‹ PLANNED

| Task | Priority | Status | Deliverable |
|------|----------|--------|-------------|
| Implement KnowledgeProtocol/Service | P2 | ğŸ“‹ | Knowledge search and retrieval |
| Implement OutputProtocol/MultiChannel | P2 | ğŸ“‹ | Multi-channel output formatting |
| Implement RefineProtocol/Metrics | P2 | ğŸ“‹ | Metrics collection and refinement |
| Add unit tests for new services | P2 | ğŸ“‹ | 90%+ coverage target |

### Part 3: API Service Implementation ğŸ“‹ PLANNED

| Task | Priority | Status | Deliverable |
|------|----------|--------|-------------|
| Implement FastAPI service | P2 | ğŸ“‹ | HTTP REST API endpoints |
| Implement CORS and rate limiting | P2 | ğŸ“‹ | Security middleware |
| Implement health check endpoint | P2 | ğŸ“‹ | /health with details |
| Add API integration tests | P2 | ğŸ“‹ | End-to-end API testing |

### Part 4: Optimization Features ğŸ“‹ PLANNED

| Task | Priority | Status | Deliverable |
|------|----------|--------|-------------|
| Implement differential_loading | P3 | ğŸ“‹ | Load only changed content |
| Implement compressed_loading | P3 | ğŸ“‹ | ~50% smaller content loading |
| Implement context_pruning | P3 | ğŸ“‹ | Auto-remove irrelevant sections |
| Add optimization benchmarks | P3 | ğŸ“‹ | Performance regression tests |

**Acceptance Criteria**:
- [x] 9 triggers with complete bilingual keywords
- [x] 12 config files in sage.yaml includes
- [x] Fallback content for graceful degradation
- [x] Configuration design document created
- [ ] DI services implemented
- [ ] API service operational
- [ ] Optimization features implemented

---

## Related

- `docs/design/07-ROADMAP.MD` â€” Roadmap overview and KPIs
- `docs/design/07A-PHASES-FOUNDATION.MD` â€” Foundation phases (0-F)
- `docs/design/05-PLUGIN-MEMORY.MD` â€” Plugin and memory design

---

*Part of SAGE Knowledge Base*
