# SAGE Timeout Configuration
#
# 5-Level Timeout Hierarchy with Circuit Breaker and Fallback Strategies
# This file is part of the modular configuration system.

# =============================================================================
# Timeout Configuration (5-Level Hierarchy)
# =============================================================================
timeout:
  global_max: 10s                      # Absolute maximum (T5)
  default: 5s                          # Default if not specified (T4)

  operations:
    cache_lookup: 100ms                # T1 - Cache hits
    file_read: 500ms                   # T2 - Single file operations
    layer_load: 2s                     # T3 - Layer/directory loading
    full_load: 5s                      # T4 - Complete KB load
    analysis: 10s                      # T5 - Complex analysis
    mcp_call: 10s                      # MCP tool timeout
    search: 3s                         # Search operations

  strategies:
    on_timeout:
      - return_partial                 # Return what is available
      - use_fallback                   # Use cached/default content
      - log_warning                    # Log for monitoring
      - never_hang                     # Guarantee response

  # Circuit Breaker Pattern
  circuit_breaker:
    enabled: true
    failure_threshold: 3               # Open after 3 consecutive failures
    reset_timeout: 30s                 # Try again after 30 seconds
    half_open_requests: 1              # Test requests in a half-open state

  # Fallback Behavior Configuration
  fallback:
    strategy: graceful                 # graceful | strict | none
    cache_stale_ms: 60000              # Use stale cache up to 60 seconds

    timeout_short: # Timeout < 5s
      action: return_partial
      description: "Return partial results"
    timeout_long: # Timeout > 5s
      action: return_core
      description: "Return core principles"
    file_not_found:
      action: return_error
      description: "Return helpful error message"
    parse_error:
      action: return_raw
      description: "Return raw content"
    network_error:
      action: use_cache
      description: "Use cached content"

  # ===========================================================================
  # Retry Configuration
  # ===========================================================================
  retry:
    enabled: true                      # Enable automatic retries
    max_attempts: 3                    # Maximum retry attempts
    initial_delay_ms: 100              # Initial delay before first retry
    max_delay_ms: 2000                 # Maximum delay between retries
    exponential_backoff: true          # Use exponential backoff
    backoff_multiplier: 2.0            # Multiply delay by this factor
    jitter: true                       # Add randomness to prevent thundering herd
    jitter_factor: 0.1                 # Â±10% jitter

    # Retryable conditions
    retry_on:
      - timeout                        # Retry on timeout
      - connection_error               # Retry on connection errors
      - rate_limited                   # Retry when rate limited (with backoff)

    # Non-retryable conditions
    no_retry_on:
      - validation_error               # Don't retry validation errors
      - not_found                      # Don't retry 404s
      - authentication_error           # Don't retry auth errors

    # Per-operation retry overrides
    operations:
      cache_lookup:
        enabled: false                 # Don't retry cache lookups
      file_read:
        max_attempts: 2
        initial_delay_ms: 50
      layer_load:
        max_attempts: 3
        initial_delay_ms: 200
      analysis:
        max_attempts: 2
        initial_delay_ms: 500

  # ===========================================================================
  # Graceful Degradation Levels
  # ===========================================================================
  degradation:
    enabled: true                      # Enable graceful degradation
    auto_detect: true                  # Auto-detect degradation triggers

    # Degradation levels (from healthy to critical)
    levels:
      - name: normal
        timeout_multiplier: 1.0
        description: "Full functionality"
        disable_features: [ ]

      - name: degraded
        timeout_multiplier: 0.5        # Reduce timeouts by 50%
        description: "Reduced functionality for stability"
        disable_features:
          - semantic_search
          - full_analysis
          - content_expansion

      - name: limited
        timeout_multiplier: 0.3        # Reduce timeouts by 70%
        description: "Core functionality only"
        disable_features:
          - semantic_search
          - full_analysis
          - content_expansion
          - plugin_execution
          - cross_references

      - name: emergency
        timeout_multiplier: 0.2        # Reduce timeouts by 80%
        description: "Emergency mode - minimal operations"
        disable_features:
          - semantic_search
          - full_analysis
          - content_expansion
          - plugin_execution
          - cross_references
          - caching
          - event_publishing

    # Triggers for automatic degradation
    triggers:
      error_rate:
        threshold: 0.1                 # 10% error rate
        window_seconds: 60
        target_level: degraded

      timeout_rate:
        threshold: 0.05                # 5% timeout rate
        window_seconds: 60
        target_level: degraded

      latency_p99:
        threshold_ms: 5000             # 5s p99 latency
        window_seconds: 60
        target_level: degraded

      memory_usage:
        threshold_percent: 90
        target_level: limited

      circuit_breaker_open:
        count: 2                       # 2 open circuit breakers
        target_level: limited

    # Recovery configuration
    recovery:
      auto_recover: true               # Automatically recover when healthy
      check_interval_seconds: 30       # Check for recovery every 30s
      required_healthy_checks: 3       # Require 3 healthy checks to recover
      recovery_step: true              # Recover one level at a time
